#ifndef TRACKONE_H
#define TRACKONE_H

#include "Scene.h"
#include "TrackCommon.h"
#include <vector>

class TrackOne : public Scene {
private:
    unsigned int mTrackData[TRACK_WIDTH * TRACK_HEIGHT] = {
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,503,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,501,000,
        000,000,503,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,114, 96,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186, 78, 60,000,000,501,000,
        000,000,503,000,113, 95,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184, 77, 59,000,000,000,000,
        000,000,000,000,203,167,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,203,167,000,000,501,000,
        000,000,503,000,203,167,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,203,167,000,000,000,000,
        000,000,000,000,203,167,000,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,000,000,203,167,000,000,501,000,
        000,000,503,000,203,167,000,000,501,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,503,000,000,203,167,000,000,000,000,
        000,000,000,000,203,167,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,203,167,000,000,501,000,
        000,000,503,000,203,167,000,000,501,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,503,000,000,203,167,000,000,000,000,
        000,000,000,000,203,167,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,203,167,000,000,501,000,
        000,000,503,000,203,167,000,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,500,000,000,000,203,167,000,000,000,000,
        000,000,000,000,203,167,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,203,167,000,000,501,000,
        000,000,503,000,203,167,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,203,167,000,000,000,000,
        000,000,000,000,112, 94,186,186,186,186,186,186,186,186,186,186,307,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186, 76, 58,000,000,501,000,
        000,000,503,000,111, 93,184,184,184,184,184,184,184,184,184,184,271,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184, 75, 57,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,501,000,
        000,000,503,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,502,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
        000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000    
    };

    // corner detection system
    std::vector<Corner> corners;
    int currentCorner = 0;

    // AI racing line
    std::vector<Vector2> aiWaypoints;
    std::vector<int> aiCurrentWaypoint; // current waypoint index for each AI car
    void setupAIWaypoints();
    void updateAI(Car* aiCar, int aiIndex, float dt);
    Vector2 tileToWorld(int col, int row);

    Car* mCar = nullptr; // player car
    std::vector<Car*> mAICars; // AI opponent cars

    // game mode
    int mGameMode = 0; // 0 = hotlap, 1 = race

    // hotlap tracking
    bool mInLap = false;
    bool mLapDisqualified = false;
    bool mWasOnStartLine = false;

    float mCurrentLapTime = 0.0f;
    float mBestLapTime = 0.0f;

    Vector2 startLineTop;
    Vector2 startLineBottom;
    Vector2 mPrevCarPos;

    // race tracking
    std::vector<int> mLapCount;        // lap count for each car
    std::vector<Vector2> mPrevCarPositions; // previous positions for line crossing
    bool mRaceFinished = false;
    int mPlayerFinishPosition = 0;
    int mRaceCurrentCorner = 0;
    bool mIncompleteLapWarning = false; // warning for incomplete lap
    bool mResultSoundPlayed = false;

    // Vignette shader
    Shader mVignetteShader;
    int mLightPositionLoc;

    bool isInsideCorner(int col, int row, int cornerIndex);

public:
    static constexpr float TILE_SIZE = 450.0f;

    TrackOne();
    TrackOne(Vector2 origin, const char *bgHexCode);
    TrackOne(Vector2 origin, const char *bgHexCode, int gameMode);
    ~TrackOne();
    
    void initialise() override;
    void update(float dt) override;
    void render() override;
    void shutdown() override;
    void renderUI();

    void setGameMode(int gameMode) { mGameMode = gameMode; }
};

#endif
